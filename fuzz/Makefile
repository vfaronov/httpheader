.PHONY: *.fuzz binary fuzz.go clean

TIME=10m

*.fuzz: binary
	timeout --foreground --signal=INT --preserve-status $(TIME) \
		go-fuzz -func Fuzz$(subst -,,$(subst .fuzz,,$@)) -workdir $@

binary:
	go generate
	go-fuzz-build

fuzz.go: *.fuzz/code.go.in
	sed -i -e '/Code generated/,$$d' $@
	echo '// Code generated by `make fuzz.go`. DO NOT EDIT.' >>$@
	cat $^ >>$@

clean:
	rm -fd *.zip *.fuzz/crashers *.fuzz/suppressions
	find *.fuzz/corpus -type f \! -name '*.in' -delete
	cd ../ && go mod edit -droprequire=github.com/dvyukov/go-fuzz
	cd ../ && go mod tidy
